name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bdp_workspace:
        description: 'Environment (workspace) to deploy/update'
        required: true
        default: 'dev-us'
        type: choice
        options:
          - dev-us
          - stage-us
          - prod-us
          - prod-npb
      action:
        description: 'Terraform action. If destroying, have you disabled delete protection?'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
      deploy_pulsar:
        description: 'Whether to (re-)deploy Pulsar. Not recommended when upgrading an existing environment - if doing so, stop all BDP & Pulsar services beforehand.'
        required: true
        default: 'no'
        type: choice
        options:
          - no
          - yes

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TF_VERSION: 1.5.7

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Load config
        id: load_config
        run: |
          config_file="BDP/terraform/conf/${{ github.event.inputs.bdp_workspace }}.yml"
          echo "Loading config from $config_file"
          vars=$(cat $config_file | yq e -o=json)
          echo "vars=$vars" >> $GITHUB_ENV

      - name: Write Terraform vars
        run: |
          vars_to_remove="aws_account workspace_name aws_s3_tracking_bucket_region pulsar_jwt_symmetric_key pulsar_jwt_proxy_admin_token pulsar_jwt_broker_admin_token pulsar_jwt_fw_admin_token pulsar_jwt_internal_admin_token pulsar_manager_admin_password tracking_sink_version tracking_sink_count segment_function_version segment_function_count datadog_global_processing_rules"
          filtered_vars=$(echo $vars | jq 'del(.[] | select(index($vars_to_remove) != null))')
          echo $filtered_vars | jq '.' > BDP/terraform/terraform.tfvars.json

      - name: Terraform init and plan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          cd BDP/terraform
          terraform init -upgrade
          terraform workspace select ${{ vars.workspace_name }} || terraform workspace new ${{ vars.workspace_name }}
          terraform workspace show
          
      - name: Plan Terraform
        if: ${{ github.event.inputs.action == 'destroy' }}
        uses: HawkEyeInnovations/GithubSharedWorkflows/.github/workflows/terraform-plan.yml@v0.0.41
        with:
          working_directory: ${{ github.event.inputs.project }}/${{ github.event.inputs.layer }}
          aws_region: ${{ github.event.inputs.aws_region }}
          aws_account_id: ${{ github.event.inputs.env == 'dev' && '682352645723' || github.event.inputs.env == 'prod' && '682171097471' || '682352645723' }}
          aws_role_session_name: gha-plan-baseball-infra
          var_file: ../${{ github.event.inputs.env }}.tfvars
          workspace: ${{ github.event.inputs.env }}
          create_workspace_if_not_exists: true
          run_checkov: true
          checkov_soft_fail: true
          run_tflint: true
          plan_options: ${{ github.event.inputs.action == 'destroy' && '-destroy -detailed-exitcode' || '' }}
        secrets: inherit
        continue-on-error: true

      - name: Approval
        if: env.plan_status == 2
        uses: hmarr/auto-approve-action@v2

      - name: Terraform apply/destroy
        if: env.plan_status == 2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          cd BDP/terraform
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            terraform apply -auto-approve ./plan.bin
            ansible_hosts=$(terraform output -raw ansible-inventory)
            echo "$ansible_hosts" > ../Pulsar/ansible/inventory/hosts
            pulsar_service_url=$(terraform output -raw pulsar_public_nlb_broker_url)
            pulsar_http_url=$(terraform output -raw pulsar_public_nlb_admin_url)
          else
            terraform destroy -auto-approve
            terraform workspace select default
            terraform workspace delete ${{ vars.workspace_name }}
          fi

      - name: Deploy Pulsar
        if: github.event.inputs.deploy_pulsar == 'yes' && github.event.inputs.action == 'apply' && env.plan_status == 2
        run: |
          cat > BDP/Pulsar/ansible/vars/variables.yml <<EOF
datadog_api_key: ${{ vars.datadog_api_key }}
datadog_global_processing_rules: ${{ vars.datadog_global_processing_rules }}
pulsar_service_url: ${{ pulsar_service_url }}
pulsar_http_url: ${{ pulsar_http_url }}
pulsar_jwt_symmetric_key: ${{ vars.pulsar_jwt_symmetric_key }}
pulsar_jwt_proxy_admin_token: ${{ vars.pulsar_jwt_proxy_admin_token }}
pulsar_jwt_broker_admin_token: ${{ vars.pulsar_jwt_broker_admin_token }}
pulsar_jwt_fw_admin_token: ${{ vars.pulsar_jwt_fw_admin_token }}
pulsar_jwt_internal_admin_token: ${{ vars.pulsar_jwt_internal_admin_token }}
pulsar_jwt_bdp_admin_token: ${{ vars.pulsar_jwt_bdp_admin_token }}
environment_name: ${{ vars.workspace_name }}
aws_s3_tracking_bucket_region: ${{ vars.aws_s3_tracking_bucket_region }}
aws_s3_tracking_bucket: ${{ vars.aws_s3_tracking_bucket }}
pulsar_manager_admin_password: ${{ vars.pulsar_manager_admin_password }}
tracking_sink_version: ${{ vars.tracking_sink_version }}
tracking_sink_count: ${{ vars.tracking_sink_count }}
segment_function_version: ${{ vars.segment_function_version }}
segment_function_count: ${{ vars.segment_function_count }}
aws_region: ${{ vars.aws_region }}
aws_dynamo_ttlSeconds: ${{ vars.aws_dynamo_ttlSeconds }}
EOF
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          docker build -t hawk-eye/ansible BDP/Pulsar/ansible
          docker run --rm --name jenkins-${{ github.run_id }} -v ${{ github.workspace }}/BDP/Pulsar/ansible:/ansible/playbooks hawk-eye/ansible ansible-playbook -v --user ec2-user --inventory playbooks/inventory/hosts playbooks/deploy-pulsar.yml

      - name: Notify Slack (Success)
        if: success()
        uses: rtCamp/action-slack-notify@v2
        with:
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: "Successful: Job '${{ github.event_name }} [${{ github.run_number }}]' to '${{ github.event.inputs.action }}' (${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          color: "#00ff48"

      - name: Notify Slack (Failure)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        with:
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: "Failed: Job '${{ github.event_name }} [${{ github.run_number }}]' to '${{ github.event.inputs.action }}' (${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          color: "#f20000"
